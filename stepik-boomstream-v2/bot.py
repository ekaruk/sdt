

from telegram import (
    Update,
    InlineKeyboardButton,
    InlineKeyboardMarkup,
    WebAppInfo,
)
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    ContextTypes,
)

from datetime import datetime

BOT_TOKEN = "8570792426:AAHlF4WaDjh-0NyqBsmngFCVM9QQazkVudY"
WEBAPP_URL2 = "https://play.boomstream.com/TsQAJHvj?id_recovery=sdt20252"

SECTIONS = {
    "561993": {
        "title": "–†–∞–∑–¥–µ–ª 1. –û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–µ—Ä–≥–∏–∏",
        "subs": [
            "–£—Ä–æ–∫ 1. –û—Å–Ω–æ–≤–Ω—ã–µ –∂–µ–ª–∞–Ω–∏—è —á–µ–ª–æ–≤–µ–∫–∞",
            "–£—Ä–æ–∫ 2. –ü—Å–∏—Ö–∏—á–µ—Å–∫–æ–µ —Ç–µ–ª–æ",
            "–£—Ä–æ–∫ 3. –û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–µ—Ä–≥–∏–∏",
            "–£—Ä–æ–∫ 4. –•—Ä–æ–Ω–∏—á–µ—Å–∫–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–µ—Ö–≤–∞—Ç–∫–∏ —ç–Ω–µ—Ä–≥–∏–∏",
            "–£—Ä–æ–∫ 5. –í–∏–¥—ã –ø–µ—Ä–µ–Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è",
            "–£—Ä–æ–∫ 6. –ò–ª–ª—é–∑–∏–∏",
            "–£—Ä–æ–∫ 7. –û –∫—Ä–∞—Å–æ—Ç–µ, –≤–ª–∏—è–Ω–∏–∏, –±–µ—Å–ø–ª–æ–¥–∏–∏",
            "–£—Ä–æ–∫ 8. –ü—Å–∏—Ö–∏—á–µ—Å–∫–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ. –ö–∞–∫ –∏ –≥–¥–µ –æ–Ω–æ —Å–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è?",
            "–£—Ä–æ–∫ 9. –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ –∏ –ø—Å–∏—Ö–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ–ª–∞",
            "–£—Ä–æ–∫ 10. –ü—Å–∏—Ö–∏—á–µ—Å–∫–∏–µ –∫–∞–Ω–∞–ª—ã: –®—Ä–æ—Ç–æ—Å—ã –∏ –ù–∞–¥–∏",
        ],
    },
    "579296": {
        "title": "–†–∞–∑–¥–µ–ª 2. –ë–ª–æ–∫–∏",
        "subs": [
            "–£—Ä–æ–∫ 11. –ü—Å–∏—Ö–∏—á–µ—Å–∫–∏–µ —Å–ª–æ–∏. –ò—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä–∞.",
            "–£—Ä–æ–∫ 12. –ü—Å–∏—Ö–∏—á–µ—Å–∫–∏–µ —Å–ª–æ–∏. –ò—Ö —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –ø—Å–∏—Ö–∏—á–µ—Å–∫–æ–º —Ç–µ–ª–µ.",
            "–£—Ä–æ–∫ 13. –ë–ª–æ–∫–∏. –ö–∞–∫ –æ–Ω–∏ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –∏ –∫–∞–∫ –≤–ª–∏—è—é—Ç –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞.",
            "–£—Ä–æ–∫ 14. –ü—Ä–∞–Ω–∞. –ï—ë –¥–≤–∏–∂–µ–Ω–∏–µ –≤ –æ—Ä–≥–∞–Ω–∏–∑–º–µ.",
            "–£—Ä–æ–∫ 15. –ë–ª–æ–∫–∏ –Ω–∞ –≥–ª—É–±–æ–∫–∏—Ö —Å–ª–æ—è—Ö",
            "–£—Ä–æ–∫ 16. –ë–ª–æ–∫–∏ –∏ –∏—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Å–ª–æ—è—Ö",
            "–£—Ä–æ–∫ 17. –í–ª–∏—è–Ω–∏–µ –Ω–µ—Ö–≤–∞—Ç–∫–∏ —ç–Ω–µ—Ä–≥–∏–∏ –Ω–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ —Ç–µ–ª–æ.",
            "–£—Ä–æ–∫ 18. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –±–æ–ª–µ–∑–Ω–µ–π –∏ –±–ª–æ–∫–æ–≤",
            "–£—Ä–æ–∫ 19. –í–∏–¥—ã –∏ –ø—Ä–∞–≤–∏–ª–∞ –æ—á–∏—â–µ–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–º–∞",
            "–£—Ä–æ–∫ 20. –ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–∏ –ø—Ä–∞–≤–∏–ª –æ—á–∏—â–µ–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–º–∞.",
        ],
    },
    "564649": {
        "title": "–†–∞–∑–¥–µ–ª 3. –û—Ü–µ–Ω–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è",
        "subs": [
            "–£—Ä–æ–∫ 21. –û—Ü–µ–Ω–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–º–∞",
            "–£—Ä–æ–∫ 22. –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–¥–æ—Ä–æ–≤—å—è —á–µ–ª–æ–≤–µ–∫–∞",
            "–£—Ä–æ–∫ 23. –ü–µ—Ä–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è –∑–¥–æ—Ä–æ–≤—å—è",
            "–£—Ä–æ–∫ 24. –í—Ç–æ—Ä–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è –∑–¥–æ—Ä–æ–≤—å—è",
            "–£—Ä–æ–∫ 25.1 –¢—Ä–µ—Ç—å—è –≥—Ä—É–ø–ø–∞ –∑–¥–æ—Ä–æ–≤—å—è",
            "–£—Ä–æ–∫ 25.2 –ß–µ—Ç–≤—ë—Ä—Ç–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è –∑–¥–æ—Ä–æ–≤—å—è",
        ],
    },
    "579297": {
        "title": "–†–∞–∑–¥–µ–ª 4. –í–æ–¥–∞",
        "subs": [
            "–£—Ä–æ–∫ 26. –ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–µ–π –≤–æ–¥—ã",
            "–£—Ä–æ–∫ 27. –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–µ–π –≤–æ–¥—ã (—á–∞—Å—Ç—å 1)",
            "–£—Ä–æ–∫ 27. –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–µ–π –≤–æ–¥—ã (—á–∞—Å—Ç—å 2)",
            "–£—Ä–æ–∫ 28. –°—Ç–∞—Ç–∏–∫–∞",
            "–£—Ä–æ–∫ 29. –°—Ç–∞—Ç–∏–∫–∞",
            "–£—Ä–æ–∫ 30. –î–µ—Ä–µ–≤—å—è",
        ],
    },
    "611382": {
        "title": "–†–∞–∑–¥–µ–ª 5. –í–æ–∑–¥—É—Ö",
        "subs": [
            "–£—Ä–æ–∫ 31. –î–∏–Ω–∞–º–∏–∫–∞",
            "–£—Ä–æ–∫ 32. –î–∏–Ω–∞–º–∏–∫–∞",
            "–£—Ä–æ–∫ 33 –î–∏–Ω–∞–º–∏–∫–∞",
            "–£—Ä–æ–∫ 34. –ü–∞—Å—Å–∏–≤–Ω–æ–µ –æ—á–∏—â–µ–Ω–∏–µ –í–æ–∑–¥—É—Ö–æ–º. –ü–æ—Å—Ç.",
        ],
    },
    "611383": {
        "title": "–†–∞–∑–¥–µ–ª 6. –°–æ–ª–Ω—Ü–µ",
        "subs": [
            "–£—Ä–æ–∫ 35. –ü–æ—Å—Ç—ã",
            "–£—Ä–æ–∫ 35. –ü–æ—Å—Ç—ã (—á–∞—Å—Ç—å 2)",
            "–£—Ä–æ–∫ 36. –ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –°–æ–ª–Ω—Ü–µ–º –Ω–∞ –æ—Ç–∫—Ä—ã—Ç–æ–º —Å–æ–ª–Ω—Ü–µ",
            "–£—Ä–æ–∫ 37. –ü—Ä–∞–∫—Ç–∏–∫–∞ –ë–∞–Ω–∏/–°–∞—É–Ω—ã/–•–∞–º–∞–º",
            "–£—Ä–æ–∫ 37. –ü—Ä–∞–∫—Ç–∏–∫–∞ –ë–∞–Ω–∏/–°–∞—É–Ω—ã/–•–∞–º–∞–º (—á–∞—Å—Ç—å2)",
            "–£—Ä–æ–∫ 38. –í–ª–∏—è–Ω–∏–µ –∫–ª–∏–º–∞—Ç–∞",
            "–£—Ä–æ–∫ 39. –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —á–µ–ª–æ–≤–µ–∫–∞",
        ],
    },
}

WIDE_PREFIX_1 = "\u2800" * 2
WIDE_PREFIX_2 = "\u2800" * 40


def build_sections_keyboard() -> InlineKeyboardMarkup:
    """1-–π —É—Ä–æ–≤–µ–Ω—å: —Ä–∞–∑–¥–µ–ª—ã + –∫–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"""
    keyboard = []

    for sec_id, data in SECTIONS.items():
        title = f"{WIDE_PREFIX_1}{data['title']}{WIDE_PREFIX_2}"
        keyboard.append([
            InlineKeyboardButton(
                text=title,
                callback_data=f"sec:{sec_id}",
            )
        ])

    # –≤–Ω–∏–∑—É –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ–Ω—é
    keyboard.append([
        InlineKeyboardButton(
            text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å –º–µ–Ω—é",
            callback_data="refresh:sections",
        )
    ])

    return InlineKeyboardMarkup(inline_keyboard=keyboard)


def build_subsections_keyboard(section_id: str) -> InlineKeyboardMarkup:
    """2-–π —É—Ä–æ–≤–µ–Ω—å: –ø–æ–¥—Ä–∞–∑–¥–µ–ª—ã (–æ—Ç–∫—Ä—ã–≤–∞—é—Ç Boomstream) + –ù–∞–∑–∞–¥ + –û–±–Ω–æ–≤–∏—Ç—å"""
    keyboard = []
    subs = SECTIONS[section_id]["subs"]

    for idx, sub_title in enumerate(subs, start=1):
        url = WEBAPP_URL2
        title = f"{sub_title}{WIDE_PREFIX_2}"
        keyboard.append([
            InlineKeyboardButton(
                text=title,
                web_app=WebAppInfo(url=url),  # –ø—Ä–æ—Å—Ç–æ —Å—Å—ã–ª–∫–∞, —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –≤ Web, –∏ –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ
            )
        ])

    # —Å—Ç—Ä–æ–∫–∞ —Å –ù–∞–∑–∞–¥ –∏ –û–±–Ω–æ–≤–∏—Ç—å
    keyboard.append([
        InlineKeyboardButton(
            text="‚¨Ö –ù–∞–∑–∞–¥ –∫ —Ä–∞–∑–¥–µ–ª–∞–º",
            callback_data="back:sections",
        ),
        InlineKeyboardButton(
            text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å –º–µ–Ω—é",
            callback_data="refresh:sections",
        ),
    ])

    return InlineKeyboardMarkup(inline_keyboard=keyboard)


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /start ‚Äî —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–¥–µ–ª—ã"""
    await update.message.reply_text(
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:",
        reply_markup=build_sections_keyboard(),
    )


async def handle_callbacks(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data
    await query.answer()

    # –≤—ã–±–æ—Ä —Ä–∞–∑–¥–µ–ª–∞
    if data.startswith("sec:"):
        _, sec_id = data.split(":", maxsplit=1)

        text = (
            f"–í—ã –≤—ã–±—Ä–∞–ª–∏: {SECTIONS[sec_id]['title']}\n"
            f"–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–∫:"
        )
        await query.edit_message_text(
            text=text,
            reply_markup=build_subsections_keyboard(sec_id),
        )

    # –Ω–∞–∑–∞–¥ –∫ —Ä–∞–∑–¥–µ–ª–∞–º
    elif data == "back:sections":
        await query.edit_message_text(
            text="–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:",
            reply_markup=build_sections_keyboard(),
        )

    # –æ–±–Ω–æ–≤–∏—Ç—å –º–µ–Ω—é —Ä–∞–∑–¥–µ–ª–æ–≤
    elif data == "refresh:sections":
        await query.edit_message_text(
            text=f"–ú–µ–Ω—é –æ–±–Ω–æ–≤–ª–µ–Ω–æ {datetime.now().strftime('%H:%M:%S')}. –í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:",
            reply_markup=build_sections_keyboard(),
        )


def main():
    app = Application.builder().token(BOT_TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(handle_callbacks))

    app.run_polling()


if __name__ == "__main__":
    main()

