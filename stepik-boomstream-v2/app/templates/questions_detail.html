{% from 'questions/_question_card.html' import render_question_card %}

        <!doctype html>
        <html lang="ru">

        <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>{{ question.title or '–í–æ–ø—Ä–æ—Å #' + question.id|string }}</title>
          <script src="https://telegram.org/js/telegram-web-app.js"></script>
          <style>
            body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              max-width: 700px;
              margin: 0 auto;
              padding: 8px 5px; /* —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã –ø–æ –∫—Ä–∞—è–º */
              line-height: 1.5;
              background: #f5f5f5;
            }
            .back-link { display: inline-block; margin-bottom: 12px; color: #667eea; text-decoration: none; font-size: 15px; }
            .back-link:hover { text-decoration: underline; }
            .card { background: white; padding: 12px 10px; border-radius: 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.04); border: 1px solid rgba(0, 0, 0, 0.08); }

            .similar-questions { margin-top: 16px; }
            .section-title { font-size: 16px; margin: 16px 0 10px; color: #222; }
            .questions-list { display: flex; flex-direction: column; gap: 16px; }
            .question-card { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid rgba(0, 0, 0, 0.08); }
            .question-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
            .question-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; gap: 12px; }
            .question-header-left { flex: 1; min-width: 0; }
            .question-header-right { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
            .question-modules { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
            .question-title { font-size: 17px; font-weight: 600; color: #222; margin-bottom: 8px; }
            .question-body { color: #555; font-size: 14px; line-height: 1.5; margin-bottom: 12px; }
            .vote-button { display: flex; align-items: center; gap: 6px; background: none; border: none; cursor: pointer; font-size: 15px; padding: 6px 12px; border-radius: 20px; transition: all 0.2s; }
            .vote-button:hover { background: #f5f5f5; }
            .vote-button.voted { color: #e91e63; }
            .summary-block { background: #f9fbe7; border-left: 4px solid #9ccc65; padding: 10px; margin-top: 12px; border-radius: 4px; }
            .summary-block strong { color: #558b2f; display: block; margin-bottom: 6px; }
            .read-more-btn { display: inline-block; margin-top: 8px; color: #558b2f; text-decoration: none; font-weight: 600; font-size: 13px; }
            .read-more-btn:hover { text-decoration: underline; }
            .telegram-link { display: inline-block; margin-top: 8px; padding: 6px 12px; background: #0088cc; color: white; text-decoration: none; border-radius: 6px; font-size: 12px; }
            .telegram-link:hover { background: #006699; }
            /* --- EDIT FORM FIELDS: —É–±–∏—Ä–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, –¥–µ–ª–∞–µ–º —à–∏—Ä–∏–Ω—É 100% --- */
            .edit-form .form-group input[type="text"],
            .edit-form .form-group select,
            .edit-form .form-group textarea {
              width: 100%;
              box-sizing: border-box;
              font-size: 15px;
              border-radius: 8px;
              border: 1px solid #e0e0e0;
              padding: 8px 5px;
              resize: vertical;
              background: #fff;
              color: #222;
              margin: 0;
            }
            .edit-form .form-group textarea#body { min-height: 180px; }
            .edit-form .form-group textarea#answer { min-height: 220px; }
            .edit-form .form-group textarea#summary { min-height: 80px; }
            /* –£–±–∏—Ä–∞–µ–º –≤—Å–µ –º–æ–±–∏–ª—å–Ω—ã–µ/–º–∏–Ω–∏–∞–ø–ø-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è edit-form */
            .modules-status-row {
              display: flex;
              justify-content: space-between;
              align-items: flex-start; /* keep status aligned to top */
              margin-bottom: 8px;
              gap: 8px;
            }
            .modules { display: flex; gap: 6px; overflow: hidden; min-width: 0; }
            .module-badge { background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 10px; font-size: 12px; white-space: nowrap; flex: 0 0 auto; text-overflow: ellipsis; overflow: hidden; max-width: 160px; }
            .status-badge { padding: 4px 10px; border-radius: 10px; font-size: 12px; font-weight: 600; white-space: nowrap; align-self: flex-start; margin-left: 8px; flex: 0 0 auto; }
            .similar-questions .status-badge { align-self: center; margin-left: 0; }
            .similar-questions .question-header { align-items: center; }
            .similar-questions .question-modules { margin-bottom: 0; align-items: center; }
            .status-voting { background: #fff3e0; color: #f57c00; }
            .status-scheduled { background: #e1f5fe; color: #0288d1; }
            .status-posted { background: #e8f5e9; color: #388e3c; }
            .status-closed { background: #f3e5f5; color: #7b1fa2; }
            .status-archived { background: #ede7f6; color: #512da8; }
            h1 { margin: 0 0 8px 0; color: #222; font-size: 19px; line-height: 1.2; }
            .meta { color: #999; font-size: 12px; margin-bottom: 8px; }
            .body { white-space: pre-wrap; margin-bottom: 12px; color: #333; font-size: 15px; }
            .answer-section { background: #f9fbe7; border-left: 3px solid #9ccc65; padding: 10px; border-radius: 4px; margin-top: 12px; }
            .answer-section h2 { color: #558b2f; margin-bottom: 8px; font-size: 15px; }
            .telegram-btn { display: inline-block; padding: 8px 16px; background: #0088cc; color: white; text-decoration: none; border-radius: 7px; margin-top: 10px; border: none; cursor: pointer; font-size: 13px; }
            .telegram-btn:hover { background: #006699; }
            .edit-btn { display: inline-block; padding: 7px 14px; background: #667eea; color: white; text-decoration: none; border-radius: 7px; margin-top: 10px; font-size: 13px; }
            .edit-btn:hover { background: #5568d3; }
            .similar-questions .edit-btn {
              display: inline-flex;
              align-items: center;
              justify-content: center;
              width: 24px;
              height: 24px;
              background: #c9d4ff;
              color: #2a3fb3;
              border-radius: 50%;
              font-size: 12px;
              padding: 0;
              margin-top: 0;
              line-height: 1;
            }
            .similar-questions .edit-btn:hover {
              background: #b9c7ff;
            }
            .close-discussion-btn, .archive-btn { display: inline-block; padding: 7px 14px; color: white; text-decoration: none; border-radius: 7px; margin-top: 10px; border: none; cursor: pointer; font-size: 13px; }
            .close-discussion-btn { background: #f44336; }
            .close-discussion-btn:hover { background: #d32f2f; }
            .archive-btn { background: #9c27b0; }
            .archive-btn:hover { background: #7b1fa2; }
            .action-buttons { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; gap: 8px; }
            /* @media (max-width: 600px) { ... } ‚Äî —É–¥–∞–ª–µ–Ω–æ –¥–ª—è edit-form */
          </style>
        </head>
        <body>
          <a href="{{ url_for('questions.list_questions') }}" class="back-link" id="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –≤–æ–ø—Ä–æ—Å–æ–≤</a>
          {% if question.id != 0 %}
          <div class="card">
            <div class="modules-status-row">
              <div class="modules">
                {% for module in modules %}
                  <span class="module-badge">{{ module.short_title or module.title }}</span>
                {% endfor %}
              </div>
              <span class="status-badge status-{{ question.status.lower() }}">
                {{ get_status_label(question.status) }}
              </span>
            </div>
            <h1>{{ question.title or ('–í–æ–ø—Ä–æ—Å #' + question.id|string) }}</h1>
            <div class="meta">‚ù§Ô∏è {{ votes_count }} –≥–æ–ª–æ—Å–æ–≤ | üìÖ {{ question.created_at.strftime('%d.%m.%Y %H:%M') }}</div>
            <div class="body">{{ question.body }}</div>
            {% if answer %}
              <div class="answer-section">
                <h2>‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç</h2>
                {% if answer.summary %}
                  <div style="background: #f5f5f5; padding: 8px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #558b2f; font-size: 13px;">
                    <strong style="color: #558b2f;">–ö—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç:</strong>
                    <p style="margin: 6px 0 0 0;">{{ answer.summary }}</p>
                  </div>
                {% endif %}
                <div style="white-space: pre-wrap; font-size: 13px;">{{ answer.answer }}</div>
                {% if answer.sources %}
                  <p style="margin-top: 10px; font-size: 12px; color: #666;">üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏: {{ answer.sources.text if answer.sources.text else answer.sources }}</p>
                {% endif %}
              </div>
            {% endif %}
            {% if user_role and user_role >= 1 %}
              <div class="action-buttons">
                <a href="#edit" class="edit-btn" onclick="document.getElementById('edit-form').style.display='block'; const similarBlock = document.getElementById('similar-questions'); if (similarBlock) { similarBlock.style.display = 'none'; } this.parentElement.style.display='none'; return false;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                {% if telegram_link and question.status == 'POSTED' %}
                  <a href="{{ telegram_link }}" target="_blank" class="telegram-btn">üí¨ –û–±—Å—É–∂–¥–µ–Ω–∏–µ ({{ messages_count - 1 if messages_count > 0 else 0 }})</a>
                  <button onclick="closeDiscussion({{ question.id }})" class="close-discussion-btn" id="close-btn">üîí –ó–∞–∫—Ä—ã—Ç—å –æ–±—Å—É–∂–¥–µ–Ω–∏–µ</button>
                {% elif telegram_link and question.status == 'CLOSED' %}
                  <a href="{{ telegram_link }}" target="_blank" class="telegram-btn">üí¨ –û–±—Å—É–∂–¥–µ–Ω–∏–µ –≤ Telegram ({{ messages_count - 1 if messages_count > 0 else 0 }})</a>
                  <button onclick="archiveQuestion({{ question.id }})" class="archive-btn" id="archive-btn">üì¶ –í –∞—Ä—Ö–∏–≤</button>
                {% elif telegram_link %}
                  <a href="{{ telegram_link }}" target="_blank" class="telegram-btn">üí¨ –û–±—Å—É–∂–¥–µ–Ω–∏–µ –≤ Telegram ({{ messages_count - 1 if messages_count > 0 else 0 }})</a>
                {% elif question.status == 'VOTING' %}
                  <button onclick="publishQuestion({{ question.id }})" class="telegram-btn" id="publish-btn" style="background: #26a69a;">üì¢ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ Telegram</button>
                {% endif %}
            {% if user_role is not none and user_role >= 0 and user_role < 1 %}
              {% if telegram_link %}
                <a href="{{ telegram_link }}" target="_blank" class="telegram-btn">üí¨ –û–±—Å—É–∂–¥–µ–Ω–∏–µ –≤ Telegram ({{ messages_count - 1 if messages_count > 0 else 0 }})</a>
              {% endif %}
            {% endif %}

              </div>
            {% endif %}
          {% endif %}

          {% if similar_questions %}
          <div class="similar-questions" id="similar-questions">
            <h3 class="section-title">–ü–æ—Ö–æ–∂–∏–µ –≤–æ–ø—Ä–æ—Å—ã</h3>
            <div class="questions-list">
              {% for q in similar_questions %}
                {{ render_question_card(q, 'all', 'all', 'all', user_role) }}
              {% endfor %}
            </div>
          </div>
          {% endif %}
          
          {% if user_role and user_role >= 1 %}
          <div id="edit-form" class="edit-form" style="display: {% if question.id == 0 or '#edit' in request.url %}block{% else %}none{% endif %};">
            <h2>{% if question.id == 0 %}–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞{% else %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞{% endif %}</h2>
            <form method="post" action="{{ url_for('questions.question_detail', question_id=question.id) }}">
              <div class="form-group">
                <label for="body">–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:</label>
                <textarea id="body" name="body" required>{{ question.body }}</textarea>
              </div>
              


              <div class="form-group">
                <label for="title">–ö—Ä–∞—Ç–∫–∏–π —Ç–µ–∫—Å—Ç (–¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º):</label>
                <div style="display: flex; gap: 8px; align-items: flex-start;">
                  <input type="text" id="title" name="title" value="{{ question.title or '' }}" style="flex: 1;">
                  <button type="button" class="btn btn-secondary" id="generate-title-btn" style="height: 40px;">‚ö° –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
                <small style="color: #666;">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ AI –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—Å—Ç–∞ –≤–æ–ø—Ä–æ—Å–∞</small>
                <div id="title-gen-status" style="color: #888; font-size: 13px; margin-top: 4px;"></div>
              </div>
              
              <div class="form-group">
                <label for="status">–°—Ç–∞—Ç—É—Å:</label>
                <select id="status" name="status" onchange="toggleAnswerSection()">
                  <option value="VOTING" {% if question.status == 'VOTING' %}selected{% endif %}>–í –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏</option>
                  <option value="POSTED" {% if question.status == 'POSTED' %}selected{% endif %}>–í –æ–±—Å—É–∂–¥–µ–Ω–∏–∏</option>
                  <option value="CLOSED" {% if question.status == 'CLOSED' %}selected{% endif %}>–ó–∞–∫—Ä—ã—Ç–æ</option>
                  <option value="ARCHIVED" {% if question.status == 'ARCHIVED' %}selected{% endif %}>–ê—Ä—Ö–∏–≤</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>–†–∞–∑–¥–µ–ª—ã –∫—É—Ä—Å–∞:</label>
                <div class="modules-selector">
                  {% for module in all_modules %}
                    <label class="module-checkbox-label {% if module.id in selected_module_ids %}selected{% endif %}" data-module-id="{{ module.id }}">
                      <input type="checkbox" name="modules" value="{{ module.id }}" {% if module.id in selected_module_ids %}checked{% endif %} style="display: none;">
                      <span class="module-checkbox-badge">{{ module.short_title or module.title }}</span>
                    </label>
                  {% endfor %}
                </div>
              </div>
              
              <div id="answer-section" style="display: {% if question.status in ['CLOSED', 'ARCHIVED'] %}block{% else %}none{% endif %};">
                <hr style="margin: 24px 0; border: none; border-top: 1px solid #ddd;">
                
                <h3 style="color: #558b2f; margin-bottom: 16px;">–ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç</h3>
                
                <div class="form-group">
                  <label for="answer">–ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç:</label>
                  <textarea id="answer" name="answer" style="min-height: 200px;">{{ answer.answer if answer else '' }}</textarea>
                  <small style="color: #666;">–ü–æ–¥—Ä–æ–±–Ω—ã–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ—Å–ª–µ –æ–±—Å—É–∂–¥–µ–Ω–∏—è</small>
                </div>
                

                <div class="form-group">
                  <label for="summary">–ö—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç (–¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º):</label>
                  <div style="display: flex; gap: 8px; align-items: flex-start;">
                    <textarea id="summary" name="summary" style="min-height: 80px; flex: 1;">{{ answer.summary if answer else '' }}</textarea>
                    <button type="button" class="btn btn-secondary" id="generate-summary-btn" style="height: 40px;">‚ö° –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                  </div>
                  <small style="color: #666;">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ AI –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞</small>
                  <div id="summary-gen-status" style="color: #888; font-size: 13px; margin-top: 4px;"></div>
                </div>
                
                <div class="form-group">
                  <label for="sources">–ò—Å—Ç–æ—á–Ω–∏–∫–∏ (—Å—Å—ã–ª–∫–∏ –Ω–∞ —É—Ä–æ–∫–∏, —Å–æ–æ–±—â–µ–Ω–∏—è):</label>
                  <input type="text" id="sources" name="sources" value="{{ answer.sources.text if (answer and answer.sources and answer.sources.text) else '' }}" placeholder="–£—Ä–æ–∫ 10, —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ñ–æ—Ä—É–º–µ, https://...">
                  <small style="color: #666;">–£–∫–∞–∂–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –æ—Ç–≤–µ—Ç–∞</small>
                </div>
              </div>
              
              <div class="form-actions" style="display: flex; gap: 10px; margin-top: 18px;">
                <button type="submit" class="edit-btn" style="background: #667eea; color: #fff; border: none; border-radius: 8px; padding: 10px 22px; font-size: 15px; font-weight: 600; cursor: pointer; transition: background 0.2s;">
                  üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button type="button" class="cancel-btn" style="background: #f5f5f5; color: #667eea; border: 1px solid #d1d5db; border-radius: 8px; padding: 10px 22px; font-size: 15px; font-weight: 600; cursor: pointer; transition: background 0.2s;"
                  onclick="document.getElementById('edit-form').style.display='none'; const actionButtons = document.querySelector('.action-buttons'); if (actionButtons) actionButtons.style.display='flex'; const similarBlock = document.getElementById('similar-questions'); if (similarBlock) { similarBlock.style.display = 'block'; }">
                  –û—Ç–º–µ–Ω–∞
                </button>
              </div>
            </form>
          </div>

          {% endif %}
          
          <script>
            // –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–∞ –≤ Telegram
            async function publishQuestion(questionId) {
              const btn = document.getElementById('publish-btn');
              if (!btn) return;
              
              const originalText = btn.innerHTML;
              btn.disabled = true;
              btn.innerHTML = '‚è≥ –ü—É–±–ª–∏–∫—É–µ–º...';
              
              try {
                const response = await fetch(`/questions/${questionId}/publish`, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  }
                });
                
                const data = await response.json();
                
                if (data.success) {
                  btn.innerHTML = '‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!';
                  btn.style.background = '#4caf50';
                  
                  // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                  setTimeout(() => {
                    window.location.reload();
                  }, 1000);
                } else {
                  alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å'));
                  btn.disabled = false;
                  btn.innerHTML = originalText;
                }
              } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = originalText;
              }
            }
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –æ–±—Å—É–∂–¥–µ–Ω–∏—è –≤ Telegram
            async function closeDiscussion(questionId) {
              if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–∫—Ä—ã—Ç—å –æ–±—Å—É–∂–¥–µ–Ω–∏–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                return;
              }
              
              const btn = document.getElementById('close-btn');
              const originalText = btn.innerHTML;
              btn.disabled = true;
              btn.innerHTML = '‚è≥ –ó–∞–∫—Ä—ã–≤–∞–µ–º...';
              
              try {
                const response = await fetch(`/questions/${questionId}/close-discussion`, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  }
                });
                
                const data = await response.json();
                
                if ( data.success) {
                  btn.innerHTML = '‚úÖ –ó–∞–∫—Ä—ã—Ç–æ!';
                  btn.style.background = '#4caf50';
                  
                  // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                  setTimeout(() => {
                    window.location.reload();
                  }, 1000);
                } else {
                  alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–∫—Ä—ã—Ç—å –æ–±—Å—É–∂–¥–µ–Ω–∏–µ'));
                  btn.disabled = false;
                  btn.innerHTML = originalText;
                }
              } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = originalText;
              }
            }
            
            // –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞
            async function archiveQuestion(questionId) {
              if (!confirm('–í–æ–ø—Ä–æ—Å –±—É–¥–µ—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω –≤ –∞—Ä—Ö–∏–≤. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                return;
              }
              
              const btn = document.getElementById('archive-btn');
              const originalText = btn.innerHTML;
              btn.disabled = true;
              btn.innerHTML = '‚è≥ –ê—Ä—Ö–∏–≤–∏—Ä—É–µ–º...';
              
              try {
                const response = await fetch(`/questions/${questionId}/archive`, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  }
                });
                
                const data = await response.json();
                
                if (data.success) {
                  btn.innerHTML = '‚úÖ –í –∞—Ä—Ö–∏–≤–µ!';
                  btn.style.background = '#4caf50';
                  
                  // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                  setTimeout(() => {
                    window.location.reload();
                  }, 1000);
                } else {
                  alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å'));
                  btn.disabled = false;
                  btn.innerHTML = originalText;
                }
              } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = originalText;
              }
            }
            
            // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ —Ä–∞–∑–¥–µ–ª–∞ –∏—Ç–æ–≥–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
            function toggleAnswerSection() {
              const status = document.getElementById('status').value;
              const answerSection = document.getElementById('answer-section');
              
              if (status === 'CLOSED' || status === 'ARCHIVED') {
                answerSection.style.display = 'block';
              } else {
                answerSection.style.display = 'none';
              }
            }
            
            // Toggle –º–æ–¥—É–ª–µ–π –ø—Ä–∏ –∫–ª–∏–∫–µ
            document.addEventListener('DOMContentLoaded', function() {
              document.querySelectorAll('.module-checkbox-label').forEach(label => {
                label.addEventListener('click', function(e) {
                  e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ label
                  
                  const checkbox = this.querySelector('input[type="checkbox"]');
                  checkbox.checked = !checkbox.checked;
                  this.classList.toggle('selected');
                });
              });
            
            // Hide similar questions when edit form is visible (hash-based edit or create).
            document.addEventListener('DOMContentLoaded', function() {
              const similarBlock = document.getElementById('similar-questions');
              const editForm = document.getElementById('edit-form');
              const shouldHide = (window.location.hash === '#edit') || (editForm && editForm.style.display === 'block');
              if (similarBlock && shouldHide) {
                similarBlock.style.display = 'none';
              }
            });

            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—Ä—ã—Ç–æ –ª–∏ –≤ Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) {
              const tg = window.Telegram.WebApp;
              tg.ready();
              tg.expand();
              
              // –ú–µ–Ω—è–µ–º —Å—Å—ã–ª–∫—É "–ù–∞–∑–∞–¥" –Ω–∞ Mini App –≤–µ—Ä—Å–∏—é
              const backLink = document.getElementById('back-link');
              if (backLink) {
                backLink.href = '{{ url_for("questions.miniapp") }}';
              }
              
              // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç–æ–≤—É—é —Å—Ö–µ–º—É Telegram
              if (tg.themeParams.bg_color) {
                document.body.style.background = tg.themeParams.bg_color;
              }
            }

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫—Ä–∞—Ç–∫–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞ (title) –ø–æ –∫–Ω–æ–ø–∫–µ
            document.addEventListener('DOMContentLoaded', function() {
              const genTitleBtn = document.getElementById('generate-title-btn');
              if (genTitleBtn) {
                genTitleBtn.addEventListener('click', async function() {
                  const bodyField = document.getElementById('body');
                  const titleField = document.getElementById('title');
                  const statusDiv = document.getElementById('title-gen-status');
                  if (!bodyField || !titleField) return;
                  const bodyText = bodyField.value.trim();
                  if (!bodyText) {
                    statusDiv.textContent = '–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞.';
                    return;
                  }
                  genTitleBtn.disabled = true;
                  statusDiv.textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è...';
                  try {
                    const resp = await fetch('/questions/generate-title', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ body_text: bodyText })
                    });
                    const data = await resp.json();
                    if (data.success) {
                      titleField.value = data.title;
                      statusDiv.textContent = '‚úÖ –ö—Ä–∞—Ç–∫–∏–π —Ç–µ–∫—Å—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω';
                    } else {
                      statusDiv.textContent = '–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å');
                    }
                  } catch (e) {
                    statusDiv.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message;
                  } finally {
                    genTitleBtn.disabled = false;
                  }
                });
              }
            });

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫—Ä–∞—Ç–∫–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (summary) –ø–æ –∫–Ω–æ–ø–∫–µ
            document.addEventListener('DOMContentLoaded', function() {
              const genBtn = document.getElementById('generate-summary-btn');
              if (genBtn) {
                genBtn.addEventListener('click', async function() {
                  const answerField = document.getElementById('answer');
                  const summaryField = document.getElementById('summary');
                  const statusDiv = document.getElementById('summary-gen-status');
                  if (!answerField || !summaryField) return;
                  const answerText = answerField.value.trim();
                  if (!answerText) {
                    statusDiv.textContent = '–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç.';
                    return;
                  }
                  genBtn.disabled = true;
                  statusDiv.textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è...';
                  try {
                    const resp = await fetch('/questions/generate-summary', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ answer_text: answerText })
                    });
                    const data = await resp.json();
                    if (data.success) {
                      summaryField.value = data.summary;
                      statusDiv.textContent = '‚úÖ –ö—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω';
                    } else {
                      statusDiv.textContent = '–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å');
                    }
                  } catch (e) {
                    statusDiv.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message;
                  } finally {
                    genBtn.disabled = false;
                  }
                });
              }
            });
          </script>
        </body>
        </html>
        
