<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Выбор удобного времени</title>
  <style>
    body { font-family: sans-serif; max-width: 900px; margin: 20px auto; }
    table { border-collapse: collapse; margin-top: 10px; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 4px; text-align: center; }
    th.day { min-width: 70px; }
    td.slot {
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 11px;
    }
    td.slot.selected {
      background: #4caf50;
      color: white;
    }
    .controls { margin-top: 12px; display: flex; gap: 12px; align-items: center; }
    #save-status { font-size: 14px; }
    #timezone-select { min-width: 260px; }
  </style>
</head>
<body>
  <h2>Выберите часы, когда вам удобно (по вашему местному времени)</h2>

  <p>
    Ваш часовой пояс:
    <select id="timezone-select"></select>
  </p>
  <small>
    В расписании хранится время по GMT (UTC 0). В первой колонке показано ваше местное время
    в выбранном часовом поясе.
  </small>

  <table id="schedule-table">
    <thead>
      <tr>
        <th>Ваш час</th>
        <th class="day">Пн</th>
        <th class="day">Вт</th>
        <th class="day">Ср</th>
        <th class="day">Чт</th>
        <th class="day">Пт</th>
        <th class="day">Сб</th>
        <th class="day">Вс</th>
      </tr>
    </thead>
    <tbody id="schedule-body"></tbody>
  </table>

  <div class="controls">
    <button id="btn-save">Сохранить</button>
    <span id="save-status"></span>
  </div>

  <script>
    // Данные с сервера
    const userId = {{ user_id }};
    const initialSchedule = {{ schedule_json | safe }};   // UTC-часы из БД
    let offsetHours = {{ offset_hours or 0 }};            // смещение от UTC в часах

    const days = ["mon", "tue", "wed", "thu", "fri", "sat", "sun"];
    const tbody = document.getElementById("schedule-body");
    const tzSelect = document.getElementById("timezone-select");
    const saveStatus = document.getElementById("save-status");

    // Набор популярных часовых поясов (можно расширять)
    const timezones = [
      { name: "Europe/Moscow",      offset: 3 },
      { name: "Europe/Berlin",      offset: 1 },
      { name: "Europe/Kiev",        offset: 2 },
      { name: "Europe/London",      offset: 0 },
      { name: "Europe/Paris",       offset: 1 },
      { name: "Asia/Almaty",        offset: 6 },
      { name: "Asia/Tbilisi",       offset: 4 },
      { name: "Asia/Tokyo",         offset: 9 },
      { name: "America/New_York",   offset: -5 },
      { name: "America/Chicago",    offset: -6 },
      { name: "America/Los_Angeles",offset: -8 },
      { name: "UTC",                offset: 0 }
    ];

    function guessBrowserTimezoneOffset() {
      try {
        if (!window.Intl || !Intl.DateTimeFormat) return null;
        const tzName = Intl.DateTimeFormat().resolvedOptions().timeZone;
        const found = timezones.find(t => t.name === tzName);
        if (found) return found.offset;

        // если точного совпадения по имени нет — считаем по смещению
        const minutes = -new Date().getTimezoneOffset(); // local - UTC
        return Math.round(minutes / 60);
      } catch (e) {
        return null;
      }
    }

    // Если offsetHours по каким-то причинам 0, но это не наш реальный пояс,
    // можно попытаться угадать по браузеру (опционально).
    if (offsetHours === 0) {
      const guessed = guessBrowserTimezoneOffset();
      if (guessed !== null) {
        offsetHours = guessed;
      }
    }

    function populateTimezoneSelect() {
      tzSelect.innerHTML = "";

      timezones.forEach(tz => {
        const option = document.createElement("option");
        option.value = tz.offset;
        option.textContent = `${tz.name} (UTC${tz.offset >= 0 ? "+" : ""}${tz.offset})`;
        tzSelect.appendChild(option);
      });

      // Выставляем текущее значение (если его нет в списке — выберется ближайшее по смещению)
      let foundByOffset = timezones.find(t => t.offset === offsetHours);
      if (!foundByOffset) {
        // если такого смещения нет в списке — добавим "Пользовательский"
        const customOption = document.createElement("option");
        customOption.value = offsetHours;
        customOption.textContent = `Пользовательский (UTC${offsetHours >= 0 ? "+" : ""}${offsetHours})`;
        tzSelect.appendChild(customOption);
      }
      tzSelect.value = offsetHours;
    }

    tzSelect.addEventListener("change", () => {
      offsetHours = parseInt(tzSelect.value, 10);
      updateHourLabels();
    });

    function formatLocalHour(utcHour, offset) {
      // utcHour: 0–23; offset: смещение в часах
      let local = (utcHour + offset) % 24;
      if (local < 0) local += 24;

      // отображаем как 1–24
      const display = ((local + 23) % 24) + 1;
      return display.toString().padStart(2, "0");
    }

    function renderTable() {
      tbody.innerHTML = "";

      for (let utcHour = 0; utcHour < 24; utcHour++) {
        const tr = document.createElement("tr");

        // Первая колонка — локальное время пользователя
        const thHour = document.createElement("th");
        thHour.classList.add("hour-label");
        thHour.dataset.utcHour = utcHour;
        thHour.textContent = formatLocalHour(utcHour, offsetHours);
        tr.appendChild(thHour);

        for (let d = 0; d < 7; d++) {
          const td = document.createElement("td");
          td.classList.add("slot");
          td.dataset.day = days[d];
          td.dataset.utcHour = utcHour;  // ВАЖНО: храним UTC-час

          const stored = initialSchedule[days[d]] || [];
          if (stored.includes(utcHour)) {
            td.classList.add("selected");
          }

          td.addEventListener("click", () => {
            td.classList.toggle("selected");
          });

          tr.appendChild(td);
        }

        tbody.appendChild(tr);
      }
    }

    function updateHourLabels() {
      document.querySelectorAll("th.hour-label").forEach(th => {
        const utcHour = parseInt(th.dataset.utcHour, 10);
        th.textContent = formatLocalHour(utcHour, offsetHours);
      });
    }

    function collectScheduleUTC() {
      const result = {};
      days.forEach(day => result[day] = []);

      document.querySelectorAll("td.slot.selected").forEach(cell => {
        const day = cell.dataset.day;
        const utcHour = parseInt(cell.dataset.utcHour, 10);
        result[day].push(utcHour);
      });

      days.forEach(day => result[day].sort((a, b) => a - b));
      return result;
    }

    document.getElementById("btn-save").addEventListener("click", async () => {
      const schedule = collectScheduleUTC();

      saveStatus.textContent = "Сохраняем...";
      saveStatus.style.color = "black";

      try {
        const resp = await fetch(`/schedule/${userId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            schedule: schedule,
            offset_hours: offsetHours,
          }),
        });

        const data = await resp.json();
        if (data.ok) {
          saveStatus.textContent = "Сохранено ✔";
          saveStatus.style.color = "green";
        } else {
          saveStatus.textContent = "Ошибка: " + (data.error || "unknown");
          saveStatus.style.color = "red";
        }
      } catch (e) {
        saveStatus.textContent = "Ошибка сети";
        saveStatus.style.color = "red";
      }
    });

    // Инициализация
    populateTimezoneSelect();
    renderTable();
  </script>
</body>
</html>
