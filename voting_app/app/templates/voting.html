<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Выбор удобного времени</title>
  <style>
    :root {
      /* Светлая тема по умолчанию (если не в Telegram) */
      --bg-color: #ffffff;
      --text-color: #000000;
      --border-color: #dfe5ec;
      --header-bg-color: #f2f3f5;
      --slot-selected-bg: #4caf50;
      --slot-selected-text: #ffffff;
      --accent-color: #2481cc;
      --hint-color: #6f7a86;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 8px;
      background: var(--bg-color);
      color: var(--text-color);
    }

    .container {
      max-width: 800px;
      margin: 0 auto 16px auto;
    }

    h2 {
      margin: 8px 0 6px 0;
      font-size: 18px;
    }

    small {
      color: var(--hint-color);
    }

    .tz-block {
      margin-bottom: 4px;
    }

    .tz-now-text {
      margin: 4px 0 0 0;
      font-size: 14px;
      color: var(--hint-color);
    }

    .table-wrapper {
      margin-top: 10px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 300px; /* чтобы 7 колонок не слипались */
      background: var(--bg-color);
    }

    thead tr {
      background: var(--header-bg-color);
    }

    th, td {
      border: 1px solid var(--border-color);
      padding: 3px;
      text-align: center;
      font-size: 12px;
    }

    th.day {
      min-width: 30px;
    }

    th.hour-label {
      font-weight: 500;
      width: 48px;
    }

    td.slot {
      min-width: 15;
      height: 24px;
      cursor: pointer;
      font-size: 11px;
      background: transparent;
      transition: background 0.15s ease, color 0.15s ease, transform 0.05s ease;
    }

    td.slot:hover {
      transform: scale(1.05);
      background: rgba(128, 128, 128, 0.08);
    }

    td.slot.selected {
      background: var(--slot-selected-bg);
      color: var(--slot-selected-text);
    }

    .controls {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }

    #btn-save {
      width: 100%;
      padding: 16px 20px;
      margin-top: 4px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-size: 18px;
      font-weight: 600;

      background: var(--accent-color);
      color: var(--slot-selected-text);

      box-shadow: 0 4px 12px rgba(0,0,0,0.20);
      transition: transform 0.1s ease, box-shadow 0.2s ease, background 0.15s ease;
    }

    #btn-save:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.25);
    }

    #btn-save:active {
      transform: scale(0.98);
      box-shadow: 0 2px 6px rgba(0,0,0,0.20);
    }

    #save-status {
      margin-top: 8px;
      font-size: 14px;
      text-align: center;
    }

    #timezone-select {
      min-width: 260px;
      max-width: 100%;
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background: var(--bg-color);
      color: var(--text-color);
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Выберите время, в которое Вам удобно общаться онлайн (по вашему местному времени)</h2>

    <div class="tz-block">
      <p>
        Ваш часовой пояс:
        <br>
        <select id="timezone-select"></select>
      </p>
      <p id="tz-now" class="tz-now-text">
        <!-- сюда выведем "В указанном часовом поясе сейчас HH:MM" -->
      </p>
    </div>

    <small>
      В первой колонке показано ваше местное время в выбранном часовом поясе.
    </small>

    <div class="table-wrapper">
      <table id="schedule-table">
        <thead>
          <tr>
            <th>Время у Вас</th>
            <th class="day">Пн</th>
            <th class="day">Вт</th>
            <th class="day">Ср</th>
            <th class="day">Чт</th>
            <th class="day">Пт</th>
            <th class="day">Сб</th>
            <th class="day">Вс</th>
          </tr>
        </thead>
        <tbody id="schedule-body"></tbody>
      </table>
    </div>

    <div class="controls">
      <button id="btn-save">Сохранить</button>
      <span id="save-status"></span>
    </div>
  </div>

  <script>
    let telegramId = null;
    let initialSchedule = {};
    let offsetHours = 0;

    const days = ["mon", "tue", "wed", "thu", "fri", "sat", "sun"];
    const tbody = document.getElementById("schedule-body");
    const tzSelect = document.getElementById("timezone-select");
    const saveStatus = document.getElementById("save-status");
    const tzNowEl = document.getElementById("tz-now");

    const timezones = [
    { offset: -12, name: "GMT–12 (Бейкер, Хауленд, Меридиан даты)" },
    { offset: -11, name: "GMT–11 (Американское Самоа, Ниуэ, Паго-Паго)" },
    { offset: -10, name: "GMT–10 (Гавайи — Гонолулу, Таити)" },
    { offset: -9,  name: "GMT–9 (Аляска — Анкоридж, Фэрбанкc)" },
    { offset: -8,  name: "GMT–8 (Лос-Анджелес, Сан-Диего, Ванкувер)" },
    { offset: -7,  name: "GMT–7 (Денвер, Финикс, Солт-Лейк-Сити)" },
    { offset: -6,  name: "GMT–6 (Чикаго, Мехико, Гватемала)" },
    { offset: -5,  name: "GMT–5 (Нью-Йорк, Торонто, Богота, Лима)" },
    { offset: -4,  name: "GMT–4 (Каракас, Сантьяго, Барбадос)" },
    { offset: -3,  name: "GMT–3 (Буэнос-Айрес, Сан-Паулу, Уругвай)" },
    { offset: -2,  name: "GMT–2 (Южная Георгия, Фернанду-ди-Норонья)" },
    { offset: -1,  name: "GMT–1 (Азорские острова, Кабо-Верде)" },
    { offset: 0,   name: "GMT±0 (Лондон, Рейкьявик, Дублин)" },
    { offset: 1,   name: "GMT+1 (Париж, Берлин, Мадрид, Рим)" },
    { offset: 2,   name: "GMT+2 (Киев, Хельсинки, Афины, Тель-Авив)" },
    { offset: 3,   name: "GMT+3 (Москва, Санкт-Петербург, Минск, Стамбул)" },
    { offset: 4,   name: "GMT+4 (Самара, Баку, Тбилиси, Дубай)" },
    { offset: 5,   name: "GMT+5 (Екатеринбург, Ташкент, Карачи)" },
    { offset: 6,   name: "GMT+6 (Омск, Алматы, Бишкек, Дакка)" },
    { offset: 7,   name: "GMT+7 (Красноярск, Бангкок, Ханой, Джакарта)" },
    { offset: 8,   name: "GMT+8 (Иркутск, Пекин, Шанхай, Сингапур)" },
    { offset: 9,   name: "GMT+9 (Якутск, Токио, Сеул)" },
    { offset: 10,  name: "GMT+10 (Владивосток, Сидней, Канберра)" },
    { offset: 11,  name: "GMT+11 (Магадан, Сахалин, Новая Каледония)" },
    { offset: 12,  name: "GMT+12 (Камчатка, Анадырь, Фиджи, Веллингтон)" },
    { offset: 13,  name: "GMT+13 (Тонга, Самоа, Феникс)" },
    { offset: 14,  name: "GMT+14 (Острова Лайн, Кирибати — Киритимати)" }
    ];


    function normalizeColor(c) {
      if (!c) return null;
      let v = c.toString().trim();
      if (!v) return null;
      if (v[0] !== "#") v = "#" + v;
      if (v.length === 4) {
        v = "#" + v[1] + v[1] + v[2] + v[2] + v[3] + v[3];
      }
      return v;
    }

    function formatMskShift(offset) {
    const diff = offset - 3; // МСК = UTC+3

    if (diff === 0) return "(МСК)";
    if (diff > 0) return `(МСК+${diff})`;
    return `(МСК${diff})`; // diff отрицательный, например (МСК-2)
    }

    function applyThemeFromTelegram(tg) {
      const params = tg.themeParams || {};
      const scheme = tg.colorScheme || "light";

      const lightDefaults = {
        bg_color: "#ffffff",
        text_color: "#000000",
        hint_color: "#6f7a86",
        link_color: "#2481cc",
        button_color: "#2481cc",
        button_text_color: "#ffffff",
        secondary_bg_color: "#f2f3f5",
        border_color: "#dfe5ec"
      };

      const darkDefaults = {
        bg_color: "#17212b",
        text_color: "#ffffff",
        hint_color: "#708499",
        link_color: "#61a8ff",
        button_color: "#5288c1",
        button_text_color: "#ffffff",
        secondary_bg_color: "#0e1621",
        border_color: "#3b4a5a"
      };

      const d = scheme === "dark" ? darkDefaults : lightDefaults;

      function getParamOrDefault(key, fallback) {
        return normalizeColor(params[key]) || fallback;
      }

      const bg = getParamOrDefault("bg_color", d.bg_color);
      const text = getParamOrDefault("text_color", d.text_color);
      const hint = getParamOrDefault("hint_color", d.hint_color);
      const btnBg = getParamOrDefault("button_color", d.button_color);
      const btnText = getParamOrDefault("button_text_color", d.button_text_color);
      const secondaryBg = getParamOrDefault("secondary_bg_color", d.secondary_bg_color);
      const border = getParamOrDefault("border_color", d.border_color);

      document.body.style.setProperty("--bg-color", bg);
      document.body.style.setProperty("--text-color", text);
      document.body.style.setProperty("--hint-color", hint);
      document.body.style.setProperty("--accent-color", btnBg);
      document.body.style.setProperty("--border-color", border);
      document.body.style.setProperty("--header-bg-color", secondaryBg);
      document.body.style.setProperty("--slot-selected-bg", btnBg);
      document.body.style.setProperty("--slot-selected-text", btnText);

      try {
        tg.setBackgroundColor(bg);
        tg.setHeaderColor(secondaryBg);
      } catch (e) {
        // игнорируем, если что-то не поддерживается
      }
    }

    function guessBrowserTimezoneOffset() {
      try {
        if (!window.Intl || !Intl.DateTimeFormat) return null;
        const tzName = Intl.DateTimeFormat().resolvedOptions().timeZone;
        const found = timezones.find(t => t.name === tzName);
        if (found) return found.offset;
        const minutes = -new Date().getTimezoneOffset(); // local - UTC
        return Math.round(minutes / 60);
      } catch (e) {
        return null;
      }
    }

    function populateTimezoneSelect() {
      tzSelect.innerHTML = "";

      timezones.forEach(tz => {
        const option = document.createElement("option");
        option.value = tz.offset;
//        option.textContent = `${tz.name} (UTC${tz.offset >= 0 ? "+" : ""}${tz.offset})`;
        option.textContent = `${tz.name} ${formatMskShift(tz.offset)}`;
        tzSelect.appendChild(option);
      });

      let foundByOffset = timezones.find(t => t.offset === offsetHours);
      if (!foundByOffset) {
        const customOption = document.createElement("option");
        customOption.value = offsetHours;
        customOption.textContent = `Пользовательский (UTC${offsetHours >= 0 ? "+" : ""}${offsetHours})`;
        tzSelect.appendChild(customOption);
      }
      tzSelect.value = offsetHours;
    }

    tzSelect.addEventListener("change", () => {
      offsetHours = parseInt(tzSelect.value, 10);
      updateHourLabels();
      updateTimezoneNowLabel();
    });

    function formatLocalHour(utcHour, offset) {
    let local = (utcHour + offset) % 24;
    if (local < 0) local += 24;

    // теперь отображаем локальный час как 0–23
    return local.toString().padStart(2, "0");
    }

    function renderTable() {
      tbody.innerHTML = "";

      for (let utcHour = 0; utcHour < 24; utcHour++) {
        const tr = document.createElement("tr");

        const thHour = document.createElement("th");
        thHour.classList.add("hour-label");
        thHour.dataset.utcHour = utcHour;
        thHour.textContent = formatLocalHour(utcHour, offsetHours);
        tr.appendChild(thHour);

        for (let d = 0; d < 7; d++) {
          const td = document.createElement("td");
          td.classList.add("slot");
          td.dataset.day = days[d];
          td.dataset.utcHour = utcHour;

          const stored = initialSchedule[days[d]] || [];
          if (stored.includes(utcHour)) {
            td.classList.add("selected");
          }

          td.addEventListener("click", () => {
            td.classList.toggle("selected");
          });

          tr.appendChild(td);
        }

        tbody.appendChild(tr);
      }
    }

    function updateHourLabels() {
      document.querySelectorAll("th.hour-label").forEach(th => {
        const utcHour = parseInt(th.dataset.utcHour, 10);
        th.textContent = formatLocalHour(utcHour, offsetHours);
      });
    }

    function collectScheduleUTC() {
      const result = {};
      days.forEach(day => result[day] = []);

      document.querySelectorAll("td.slot.selected").forEach(cell => {
        const day = cell.dataset.day;
        const utcHour = parseInt(cell.dataset.utcHour, 10);
        result[day].push(utcHour);
      });

      days.forEach(day => result[day].sort((a, b) => a - b));
      return result;
    }

    function getCurrentTimeInOffset(offset) {
      const now = new Date();
      const utcMs = now.getTime() + now.getTimezoneOffset() * 60000;
      const target = new Date(utcMs + offset * 3600000);
      const hh = String(target.getHours()).padStart(2, "0");
      const mm = String(target.getMinutes()).padStart(2, "0");
      return `${hh}:${mm}`;
    }

    function updateTimezoneNowLabel() {
      const timeStr = getCurrentTimeInOffset(offsetHours);
      tzNowEl.textContent = `В указанном часовом поясе сейчас ${timeStr}`;
    }

    async function loadUserData() {
      if (window.Telegram && window.Telegram.WebApp) {
        const tg = window.Telegram.WebApp;
        const user = tg.initDataUnsafe && tg.initDataUnsafe.user;

        if (user && user.id) {
          telegramId = user.id;
        }

        applyThemeFromTelegram(tg);

        tg.onEvent("themeChanged", () => {
          applyThemeFromTelegram(tg);
          updateHourLabels();
        });

        tg.expand();
      }

      if (!telegramId) {
        telegramId = 999999; // тестовый ID для браузера
      }

      try {
        const resp = await fetch(`/api/voting/${telegramId}`);
        const data = await resp.json();
        initialSchedule = data.schedule || {};
        offsetHours = data.offset_hours ?? 0;

        if (offsetHours === 0) {
          const guessed = guessBrowserTimezoneOffset();
          if (guessed !== null) offsetHours = guessed;
        }
      } catch (e) {
        initialSchedule = {};
        const guessed = guessBrowserTimezoneOffset();
        offsetHours = guessed !== null ? guessed : 0;
      }

      populateTimezoneSelect();
      renderTable();
      updateTimezoneNowLabel();

      // обновляем время раз в минуту
      setInterval(updateTimezoneNowLabel, 60000);
    }

    document.getElementById("btn-save").addEventListener("click", async () => {
      const schedule = collectScheduleUTC();

      saveStatus.textContent = "Сохраняем...";
      saveStatus.style.color = "var(--text-color)";

      try {
        const resp = await fetch(`/api/voting/${telegramId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            schedule: schedule,
            offset_hours: offsetHours,
          }),
        });

        const data = await resp.json();
        if (data.ok) {
          saveStatus.textContent = "Сохранено ✔";
          saveStatus.style.color = "green";
        } else {
          saveStatus.textContent = "Ошибка: " + (data.error || "unknown");
          saveStatus.style.color = "red";
        }
      } catch (e) {
        saveStatus.textContent = "Ошибка сети";
        saveStatus.style.color = "red";
      }
    });

    function debugTelegramContext() {
    let text = "";

    if (window.Telegram && window.Telegram.WebApp) {
        const tg = window.Telegram.WebApp;

        text += "Telegram WebApp найден ✔\n\n";

        text += "colorScheme: " + tg.colorScheme + "\n\n";

        text += "initData:\n" + tg.initData + "\n\n";

        text += "initDataUnsafe:\n" +
        JSON.stringify(tg.initDataUnsafe, null, 2) + "\n\n";

    } else {
        text += "❌ Telegram WebApp НЕ найден.\n";
    }

    const pre = document.createElement("pre");
    pre.style.fontSize = "11px";
    pre.style.whiteSpace = "pre-wrap";
    pre.style.border = "1px solid #ccc";
    pre.style.padding = "8px";
    pre.style.background = "#f8f8f8";
    pre.textContent = text;

    document.body.insertBefore(pre, document.body.firstChild);
    }
    
    debugTelegramContext();
    loadUserData();
  </script>
</body>
</html>
